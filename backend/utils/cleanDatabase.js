const { User, Client } = require('../models');
const { connectDB } = require('../config/database');
require('dotenv').config();

/**
 * Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
 * Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ²ÑĞµÑ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ superadmin
 */
const cleanDatabase = async () => {
  try {
    console.log('ğŸ§¹ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...\n');
    await connectDB();

    // 1. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
    console.log('ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²...');
    const deletedClients = await Client.destroy({ where: {} });
    console.log(`âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²: ${deletedClients}\n`);

    // 2. ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ superadmin
    console.log('ğŸ” ĞŸĞ¾Ğ¸ÑĞº ÑÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°...');
    let superadmin = await User.findOne({ where: { role: 'superadmin' } });

    if (!superadmin) {
      console.log('âš ï¸  Ğ¡ÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾...');
      superadmin = await User.create({
        fullName: 'Ğ¡ÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ñ‹',
        email: 'admin@probation.kg',
        phone: '+996700000001',
        password: '123456',
        role: 'superadmin',
        district: null,
        permissions: [],
        managedDistricts: [],
        isActive: true
      });
      console.log('âœ… Ğ¡ÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½:', superadmin.email);
    } else {
      console.log('âœ… Ğ¡ÑƒĞ¿ĞµÑ€Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:', superadmin.email);
    }

    // 3. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ ĞºÑ€Ğ¾Ğ¼Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ superadmin
    console.log('\nğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...');
    const deletedUsers = await User.destroy({
      where: {
        id: {
          [require('sequelize').Op.ne]: superadmin.id
        }
      }
    });
    console.log(`âœ… Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${deletedUsers}\n`);

    // 4. Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
    const totalUsers = await User.count();
    const totalClients = await Client.count();

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('                   ĞĞ§Ğ˜Ğ¡Ğ¢ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    console.log('ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:');
    console.log(`   Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: ${totalUsers}`);
    console.log(`   Ğ’ÑĞµĞ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ: ${totalClients}\n`);

    console.log('ğŸ” Ğ”ĞĞĞĞ«Ğ• Ğ”Ğ›Ğ¯ Ğ’Ğ¥ĞĞ”Ğ:\n');
    console.log('   Email: ' + superadmin.email);
    console.log('   ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: 123456');
    console.log('   Ğ Ğ¾Ğ»ÑŒ: Superadmin\n');

    console.log('ğŸ’¡ Ğ¡Ğ›Ğ•Ğ”Ğ£Ğ®Ğ©Ğ˜Ğ• Ğ¨ĞĞ“Ğ˜:');
    console.log('   1. Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ ĞºĞ°Ğº superadmin');
    console.log('   2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ‡ĞµÑ€ĞµĞ· Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ');
    console.log('   3. ĞĞ°Ğ·Ğ½Ğ°Ñ‡ÑŒÑ‚Ğµ Ğ¸Ğ¼ ĞœĞ Ğ£ Ğ¸ Ñ€Ğ°Ğ¹Ğ¾Ğ½Ñ‹\n');

    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    process.exit(0);
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞµ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error);
    process.exit(1);
  }
};

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
cleanDatabase();
