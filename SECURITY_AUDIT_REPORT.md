# üîê –ê–£–î–ò–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò –°–ò–°–¢–ï–ú–´ - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

**–î–∞—Ç–∞:** 2025-11-08
**–ü—Ä–æ–µ–∫—Ç:** –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–±–∞—Ü–∏–∏ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞ (–ì–û–° –ø—Ä–æ–µ–∫—Ç)
**–ê—É–¥–∏—Ç–æ—Ä:** Claude Code
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - –ù–∞–π–¥–µ–Ω—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## üìä –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:** 15+
- **–¢–∏–ø:** IDOR (Insecure Direct Object Reference), Broken Access Control
- **–†–∏—Å–∫:** –í–´–°–û–ö–ò–ô - –£—Ç–µ—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** –ù–ï–ú–ï–î–õ–ï–ù–ù–´–ô

---

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### 1. WorkSessionController - –ü–æ–ª–Ω–æ–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞

#### 1.1 `startWorkSession()` - IDOR
**–§–∞–π–ª:** `backend/controllers/workSessionController.js:8-43`
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ—é–±–æ–π –∫–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ä–∞–±–æ—á—É—é —Å–µ—Å—Å–∏—é –∑–∞ –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ clientId –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç req.user
const { clientId, startLatitude, startLongitude, workLocation } = req.body;

// –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å clientId –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
const session = await WorkSession.create({
  clientId,  // ‚ùå –ù–ï–¢ –ü–†–û–í–ï–†–ö–ò!
  startTime: new Date(),
  // ...
});
```

**–ê—Ç–∞–∫–∞:**
```bash
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ (clientId=123) —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –∑–∞ –∂–µ—Ä—Ç–≤—É (clientId=456)
POST /api/work-sessions/start
{
  "clientId": "456",  // –ß—É–∂–æ–π ID!
  "startLatitude": 42.8746,
  "startLongitude": 74.5698
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ–¥–¥–µ–ª–∫–∞ —Ä–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤ –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
- –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –§–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ —Ä–∞–±–æ—Ç—ã

#### 1.2 `endWorkSession()` - IDOR
**–§–∞–π–ª:** `backend/controllers/workSessionController.js:49-87`
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ—é–±–æ–π –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å —á—É–∂—É—é —Å–µ—Å—Å–∏—é

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–µ—Å—Å–∏–∏
const session = await WorkSession.findByPk(req.params.id);

// –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å —á—É–∂—É—é —Å–µ—Å—Å–∏—é
await session.update({
  endTime,
  hoursWorked: hoursWorked.toFixed(2),
  status: 'completed'
});
```

**–ê—Ç–∞–∫–∞:**
```bash
# –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
PUT /api/work-sessions/999/end
{
  "endLatitude": 42.8746,
  "endLongitude": 74.5698
}
```

#### 1.3 `uploadPhoto()` - IDOR
**–§–∞–π–ª:** `backend/controllers/workSessionController.js:182-236`
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ—é–±–æ–π –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∫ —á—É–∂–æ–π —Å–µ—Å—Å–∏–∏

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–µ—Å—Å–∏–∏
const session = await WorkSession.findByPk(req.params.id);

const photo = await Photo.create({
  workSessionId: session.id,  // ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞!
  photoType: photoType || 'process',
  filePath: relativePath,
  // ...
});
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä—É—é—â–∏—Ö —Ñ–æ—Ç–æ –∫ —á—É–∂–∏–º —Å–µ—Å—Å–∏—è–º
- –§–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ —Ä–∞–±–æ—Ç—ã
- –°–∞–±–æ—Ç–∞–∂ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

#### 1.4 `getWorkSessions()` - –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª:** `backend/controllers/workSessionController.js:93-136`
**–ü—Ä–æ–±–ª–µ–º–∞:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –í–°–ï —Å–µ—Å—Å–∏–∏ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ä–æ–ª–∏

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const sessions = await WorkSession.findAll({
  where: whereClause,
  // ‚ùå –û—Ñ–∏—Ü–µ—Ä –≤–∏–¥–∏—Ç —Å–µ—Å—Å–∏–∏ –í–°–ï–• –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã!
  // ‚ùå –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ –≤–∏–¥–∏—Ç —Å–µ—Å—Å–∏–∏ –í–°–ï–• —Ä–∞–π–æ–Ω–æ–≤!
  include: [/* ... */],
  order: [['createdAt', 'DESC']]
});
```

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- –û—Ñ–∏—Ü–µ—Ä ‚Üí —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ —Å–≤–æ–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ ‚Üí —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–≤–æ–µ–≥–æ —Ä–∞–π–æ–Ω–∞
- –ê–¥–º–∏–Ω –ú–†–£ ‚Üí —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–≤–æ–µ–≥–æ –ú–†–£
- Superadmin ‚Üí –≤—Å–µ —Å–µ—Å—Å–∏–∏

#### 1.5 `getWorkSession()` - IDOR
**–§–∞–π–ª:** `backend/controllers/workSessionController.js:142-176`
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ—é–±–æ–π –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –ª—é–±–æ–π —Å–µ—Å—Å–∏–∏

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞
const session = await WorkSession.findByPk(req.params.id, {
  include: [/* client, photos, verifier */]
});

// ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ—Å—Å–∏—é –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤!
res.json({ success: true, data: session });
```

---

### 2. ClientController - –ß–∞—Å—Ç–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞

#### 2.1 `getClient()` - –ù–µ–ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
**–§–∞–π–ª:** `backend/controllers/clientController.js:76-109`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ñ–∏—Ü–µ—Ä–æ–≤, –Ω–æ –ù–ï–¢ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

```javascript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ—Ñ–∏—Ü–µ—Ä–∞ –µ—Å—Ç—å
if (req.user.role === 'officer' && client.officerId !== req.user.id) {
  return res.status(403).json({ /* ... */ });
}

// ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è district_admin!
// ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è regional_admin!
// –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –î–†–£–ì–ò–• —Ä–∞–π–æ–Ω–æ–≤!
```

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è district_admin
if (req.user.role === 'district_admin') {
  if (!client.districtId || client.districtId !== req.user.districtId) {
    return res.status(403).json({ message: 'Access denied' });
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è regional_admin
if (req.user.role === 'regional_admin') {
  if (!client.officer?.mruId || client.officer.mruId !== req.user.mruId) {
    return res.status(403).json({ message: 'Access denied' });
  }
}
```

#### 2.2 `getClients()` - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É
**–§–∞–π–ª:** `backend/controllers/clientController.js:6-70`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `req.user.district` (STRING) –≤–º–µ—Å—Ç–æ `districtId` (UUID)

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å district STRING
if (req.user.role === 'district_admin' || req.user.role === 'officer') {
  if (req.user.districtId) {
    whereClause.districtId = req.user.districtId;
  } else if (req.user.district) {
    whereClause.district = req.user.district;  // –£—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ!
  }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ UUID –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –∏–º–µ—Ç—å `district=null` –∏ –≤–∏–¥–µ—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ!

---

### 3. UserController - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥—ã—Ä—ã

#### 3.1 `getUser()` - IDOR
**–§–∞–π–ª:** `backend/controllers/userController.js:43-62`
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ—é–±–æ–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –õ–Æ–ë–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –≤–æ–æ–±—â–µ!
const user = await User.findByPk(req.params.id, {
  attributes: { exclude: ['password'] }
});

// ‚ùå –û—Ñ–∏—Ü–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞!
// ‚ùå –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ñ–∏—Ü–µ—Ä–∞!
res.json({ success: true, data: user });
```

**–ê—Ç–∞–∫–∞:**
```bash
# –û—Ñ–∏—Ü–µ—Ä –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ superadmin
GET /api/users/superadmin-uuid-here
Authorization: Bearer <officer-token>
```

#### 3.2 `updateUser()` - Privilege Escalation
**–§–∞–π–ª:** `backend/controllers/userController.js:68-97`
**–ü—Ä–æ–±–ª–µ–º–∞:** Admin –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –õ–Æ–ë–û–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–∂–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ä–∞–π–æ–Ω–∞

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–π–æ–Ω–∞
const { fullName, email, phone, role, district, isActive } = req.body;

await user.update({
  fullName,
  email,
  phone,
  role,       // ‚ùå –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ –º–æ–∂–µ—Ç –ø–æ–≤—ã—Å–∏—Ç—å —Å–µ–±—è –¥–æ superadmin!
  district,   // ‚ùå –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ –ê –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∞–¥–º–∏–Ω–∞ —Ä–∞–π–æ–Ω–∞ –ë!
  isActive
});
```

**–ê—Ç–∞–∫–∞:**
```bash
# –ê–¥–º–∏–Ω —Ä–∞–π–æ–Ω–∞ –ø–æ–≤—ã—à–∞–µ—Ç —Å–≤–æ—é —Ä–æ–ª—å –¥–æ superadmin
PUT /api/users/—Å–≤–æ–µ–≥–æ-id
{
  "role": "superadmin"
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Å–∏—Å—Ç–µ–º–æ–π
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥—Ä—É–≥–∏—Ö —Ä–∞–π–æ–Ω–æ–≤

#### 3.3 `getUsers()` - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É
**–§–∞–π–ª:** `backend/controllers/userController.js:6-37`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `req.user.district` (STRING) –≤–º–µ—Å—Ç–æ `districtId`

```javascript
if (req.user.role === 'district_admin' || req.user.role === 'officer') {
  whereClause.district = req.user.district;  // ‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–µ–µ –ø–æ–ª–µ!
}
```

---

### 4. Middleware - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Å–∏—Å—Ç–µ–º—ã

#### 4.1 `roleCheck.js:canManageDistrict()`
**–§–∞–π–ª:** `backend/middleware/roleCheck.js:47-81`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `req.user.district` (STRING) –≤–º–µ—Å—Ç–æ `districtId` (UUID)

```javascript
// –£–Ø–ó–í–ò–ú–û–°–¢–¨: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ
if (userRole === 'district_admin' && req.user.district === district) {
  return next();
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ UUID —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å!

---

### 5. GeofenceController - –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö

#### 5.1 `getAllGeofences()` - –ß–∞—Å—Ç–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
**–§–∞–π–ª:** `backend/controllers/geofenceController.js:37-89`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è district_admin, –Ω–æ –Ω–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π

```javascript
if (req.user.role === 'district_admin') {
  if (req.user.districtId) {
    whereClause.districtId = req.user.districtId;
  } else if (req.user.district) {
    whereClause.district = req.user.district;
  }
}
// ‚ùå –ù–æ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è regional_admin!
// ‚ùå –û—Ñ–∏—Ü–µ—Ä –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≥–µ–æ–∑–æ–Ω—ã –¥—Ä—É–≥–∏—Ö —Ä–∞–π–æ–Ω–æ–≤!
```

---

## üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–ü–†–ò–û–†–ò–¢–ï–¢ 1)

### –≠—Ç–∞–ø 1: WorkSessionController (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)

1. **startWorkSession:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `clientId === req.user.id` –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –¥–ª—è role !== 'client'

2. **endWorkSession:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Å—Å–∏—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç req.user.id
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á—É–∂–∏—Ö —Å–µ—Å—Å–∏–π

3. **uploadPhoto:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–µ—Å—Å–∏–∏
   - ‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É

4. **getWorkSessions:**
   - ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–æ–ª–∏:
     - client ‚Üí —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–µ—Å—Å–∏–∏
     - officer ‚Üí —Å–µ—Å—Å–∏–∏ —Å–≤–æ–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
     - district_admin ‚Üí —Å–µ—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–≤–æ–µ–≥–æ —Ä–∞–π–æ–Ω–∞
     - regional_admin ‚Üí —Å–µ—Å—Å–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–≤–æ–µ–≥–æ –ú–†–£
     - superadmin ‚Üí –≤—Å–µ —Å–µ—Å—Å–∏–∏

5. **getWorkSession:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ç–æ–π –∂–µ –ª–æ–≥–∏–∫–µ

### –≠—Ç–∞–ø 2: ClientController

1. **getClient:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è district_admin
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è regional_admin
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è client (—Ç–æ–ª—å–∫–æ —Å–µ–±—è)

2. **updateClient:**
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥—Ä—É–≥–∏—Ö —Ä–∞–π–æ–Ω–æ–≤

3. **getClients:**
   - ‚úÖ –£–±—Ä–∞—Ç—å fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ district
   - ‚úÖ –¢—Ä–µ–±–æ–≤–∞—Ç—å districtId –¥–ª—è –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤

### –≠—Ç–∞–ø 3: UserController

1. **getUser:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞:
     - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–ª–ª–µ–≥ —Å–≤–æ–µ–≥–æ —Ä–∞–π–æ–Ω–∞/–ú–†–£
     - Superadmin ‚Üí –≤—Å–µ

2. **updateUser:**
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –±–µ–∑ superadmin
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥—Ä—É–≥–∏—Ö —Ä–∞–π–æ–Ω–æ–≤
   - ‚úÖ –ó–∞–ø—Ä–µ—Ç–∏—Ç—å district_admin –ø–æ–≤—ã—à–∞—Ç—å —Å–≤–æ—é —Ä–æ–ª—å

3. **getUsers:**
   - ‚úÖ –£–±—Ä–∞—Ç—å fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ district

### –≠—Ç–∞–ø 4: Middleware

1. **roleCheck.js:**
   - ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å canManageDistrict –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è districtId
   - ‚úÖ –°–æ–∑–¥–∞—Ç—å helper –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º

2. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π middleware:**
   - ‚úÖ `checkResourceOwnership` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Å–µ—Å—Å–∏–µ–π/–∫–ª–∏–µ–Ω—Ç–æ–º
   - ‚úÖ `filterByRole` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –≠—Ç–∞–ø 5: Routes

1. **workSessionRoutes.js:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å authorize –¥–ª—è getWorkSessions

2. **clientRoutes.js:**
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å authorize –¥–ª—è getClient
   - ‚úÖ –î–æ–±–∞–≤–∏—Ç—å authorize –¥–ª—è getClientStats

---

## üìù –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
1. üî¥ **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å WorkSessionController - —Ä–∏—Å–∫ —Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
2. üî¥ **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å UserController.updateUser - —Ä–∏—Å–∫ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
3. üü† **–í–´–°–û–ö–ò–ô:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –≤–æ –≤—Å–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
4. üü† **–í–´–°–û–ö–ò–ô:** –£–±—Ä–∞—Ç—å –≤—Å–µ fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É district (STRING)

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã:
1. –í–Ω–µ–¥—Ä–∏—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
2. –°–æ–∑–¥–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ penetration testing
4. –í–Ω–µ–¥—Ä–∏—Ç—å rate limiting –¥–ª—è API
5. –î–æ–±–∞–≤–∏—Ç—å –∞—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û –î–õ–Ø –†–£–ö–û–í–û–î–°–¢–í–ê

–î–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç:
- ‚úó –ö–ª–∏–µ–Ω—Ç–∞–º –≤–∏–¥–µ—Ç—å –∏ –∏–∑–º–µ–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- ‚úó –û—Ñ–∏—Ü–µ—Ä–∞–º –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∏–µ–Ω—Ç–∞–º –¥—Ä—É–≥–∏—Ö —Ä–∞–π–æ–Ω–æ–≤
- ‚úó –ê–¥–º–∏–Ω–∞–º —Ä–∞–π–æ–Ω–æ–≤ –ø–æ–≤—ã—à–∞—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –¥–æ superadmin
- ‚úó –ü–æ–¥–¥–µ–ª—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úó –ú–∞–Ω–∏–ø—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–æ–π —É—á–µ—Ç–∞ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç

**–î–ª—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —ç—Ç–æ –ù–ï–ü–†–ò–ï–ú–õ–ï–ú–´–ô —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.

---

**–ö–æ–Ω–µ—Ü –æ—Ç—á—ë—Ç–∞**
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
